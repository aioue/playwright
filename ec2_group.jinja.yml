---

# ansible template file for ec2_group

#ansible 2.3.1.0
#  config file =
#  configured module search path = Default w/o overrides
#  python version = 3.6.1 (default, Apr  4 2017, 09:40:21) [GCC 4.2.1 Compatible Apple LLVM 8.1.0 (clang-802.0.38)]

# test without changes (dry-run):
# ansible-playbook translate_terraform.yml -i inventory/tf-vpc-euc1/ --check -vvv --step

{% for group in json %}
- name: create security group [{{ loop.index }}/{{ loop.length }}] {{ group['GroupId'] }}
  ec2_group:
    description: {{ group['Description'] }}
    name: {{ group['GroupName'] }}
    purge_rules: true
    purge_rules_egress: true
    region: {{ region }}
    rules:
    {% for groupl in group['IpPermissions'] %}
      - proto: {{ groupl['IpProtocol'] }}
        from_port: {{ groupl['FromPort'] }}
        to_port: {{ groupl['ToPort'] }}
        {% if groupl['IpRanges'] == [] %}
        # https://github.com/ansible/ansible/issues/26286
        {% else %}
        cidr_ip:
        {% for iprange in groupl['IpRanges'] %}
          - {{ iprange['CidrIp'] }}
        {% endfor %}
        {% endif %}
        {% if groupl['UserIdGroupPairs'] == [] %}
        # https://github.com/ansible/ansible/issues/26291
        {% else %}
        group_id:
        {% for groupid in groupl['UserIdGroupPairs'] %}
          - {{ groupid['GroupId'] }}
        {% endfor %}
        {% endif %}
    {% endfor %}
    rules_egress:
    {% if group['IpPermissionsEgress'] == [] %}
      # https://github.com/ansible/ansible/issues/26286
      - []
    {% endif %}
    {% for groupl in group['IpPermissionsEgress'] %}
      - proto: {{ groupl['IpProtocol'] }}
        from_port: {{ groupl['FromPort'] }}
        to_port: {{ groupl['ToPort'] }}
        cidr_ip:
        {% for iprange in groupl['IpRanges'] %}
          - {{ iprange['CidrIp'] }}
        {% endfor %}
    {% endfor %}
    state: present
    vpc_id: {{ group['VpcId'] }}
  # stop on changed so we don't break anything in bulk (1 break possible!)
  register: command_result
  failed_when: command_result | changed

{% if group['Tags'] is defined %}
# tagging is not part of ec2_group
- name: tag security group
  ec2_tag:
    region: {{ region }}
    resource: {{ group['GroupId'] }}
    state: present
    tags:
    {% for tag in group['Tags'] %}
      {{ tag['Key'] }}: {{ tag['Value'] }}
    {% endfor %}
{% endif %}

{% endfor %}