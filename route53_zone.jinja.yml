---

# ansible template file for route53_zone

#ansible 2.3.1.0
#  config file =
#  configured module search path = Default w/o overrides
#  python version = 3.6.1 (default, Apr  4 2017, 09:40:21) [GCC 4.2.1 Compatible Apple LLVM 8.1.0 (clang-802.0.38)]

# test without changes (dry-run):
# ansible-playbook translate_terraform.yml -i inventory/tf-vpc-euc1/ --check -vvv --step

# vpc_id and vpc_region are not returned in the list-hosted-zones AWS API call
# ignore them for now as we are just listing existing zones

# route53_zone does not support check mode! TODO: SHOWSTOPPER for safe testing
# also it does not support multiple VPCs entered at creation time, meaning until the below PR is merged, VPC lists require multiple calls
# https://github.com/ansible/ansible/pull/21646

{% for zone in json %}
- name: manage route53 zone [{{ loop.index }}/{{ loop.length }}] {{ zone['GroupId'] }}
  route53_zone:
    comment: {{ zone['Config']['Comment'] }}
    hosted_zone_id: {{ zone['Id'] }}
    region: {{ region }}
    {# vpc_id: # {% if zone['Config']['PrivateZone'] == 'true' %}vpcid{%+ endif %} #}
    {# vpc_region: # {% if zone['Config']['PrivateZone'] == 'true' %}vpcregion{%+ endif %} #}
    zone: {{ zone['Name'] }}
  # stop on changed so we don't break anything in bulk (1 break possible!)
  register: command_result
  failed_when: command_result | changed

{% endfor %}